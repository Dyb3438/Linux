<!DOCTYPE html>
<html lang="zh-cmn-Hans">
    <head>
        <meta charset="UTF-8">
        <title>注册</title>
        <link rel="stylesheet" type="text/css" href="./css/sign.css">
        <style type="text/css">
            .loadAvatarButton {
                border: 1px #3083ff solid;
                border-radius: 4px;
                background-color: #fff;
                box-shadow: 0 5px 8px 0 rgba(24,95,255,.1);
                color: #3487ff;
                width: 300px;
                height: 40px;
                margin-top: 35px;
                margin-bottom: 8px;
                font-size: 16px;
            }
            .loadAvatarButton:hover {
                color: #3580eb;
            }
            .file {
                width: 200px;
                height: 200px;
                opacity: 0;
                left: 0;
                position: absolute;
                /*font-size: 100px;*/
            }
            .previewArea {
                width: 200px;
                height: 200px;
            }
            .fileButton {
                width: 200px;
                height: 200px;
                position: relative;
                display: inline-block;
            }
        </style>
    </head>
    <body onselectstart="return false;">
        <div id="background-slideshow">
            <div class="slideshow"></div>
            <div class="slideshow"></div>
        </div>
        <div class="container">
            <div class="title">SignUp</div>
            <form name="apply" id="apply" action="Apply.php" method="POST" target="formTarget" onsubmit="return check()" enctype="multipart/form-data">
                <div id="front" style="display: inline-block;">
                    <div class="inputArea">
                        <input type="text" name="UserId" id="UserId" class="sign-input" placeholder="账号" required="required" onfocus="initInfo(this);seeInf(this)" onblur="initInfo(this);checkUserId(this)" status="0">
                        <div class="information slideup">
                            <div class="information">不能以0开头</div>
                            <div class="information">长度为6~18位数字</div>
                        </div>
                        <div class="information warn slideup">你不能使用该账号注册</div>
                        <div class="check" style="display: none;">×</div>
                    </div>
                    <div class="inputArea">
                        <input type="text" name="UserName" id="UserName" class="sign-input" placeholder="昵称" required="required" maxlength="24" onfocus="initInfo(this);seeInf(this)" onblur="initInfo(this);checkUserName(this)" status="0">
                        <div class="information slideup">
                            <div class="information">不能超过24个字符或12个汉字</div>
                        </div>
                        <div class="information warn slideup">你不能使用该昵称注册</div>
                        <div class="check" style="display: none;">×</div>
                    </div>
                    <div class="inputArea">
                        <input type="password" name="UserPassword" id="UserPassword" class="sign-input" placeholder="密码" required="required" onfocus="initInfo(this);seeInf(this)" onblur="initInfo(this);checkUserPassword(this);checkPasswordAgain(document.getElementById('UserPasswordAgain'))" status="0">
                        <div class="information slideup">
                            <div class="information">长度为6~16个字符</div>
                            <div class="information">不能包括空格</div>
                            <div class="information">区分大小写</div>
                        </div>
                        <div class="information warn slideup">密码格式不正确</div>
                        <div class="check" style="display: none;">×</div>
                    </div>
                    <div class="inputArea">
                        <input type="password" name="" id="UserPasswordAgain" onchange="checkPasswordAgain(this)" class="sign-input" placeholder="再次输入密码" required="required">
                        <div class="information slideup"></div>
                        <div class="information warn slideup">密码不一致</div>
                        <div class="check" style="display: none;">×</div>
                    </div>
                    <div class="inputArea">
                        <input type="text" name="Code" id="Code" class="sign-input" style="width: 135px; margin-right: 135px;" placeholder="请输入验证码" required="required" maxlength="4" onfocus="initInfo(this);seeInf(this)" onblur="initInfo(this)">
                        <div class="information slideup">
                            <div class="information">单击图片切换验证码</div>
                        </div>
                        <div class="information warn slideup">验证码不正确</div>
                        <div class="check" style="display: none;">×</div>
                        <img id="code" src="code.php" class="code" onclick="this.src='code.php?p'+Math.random()">
                    </div>
                    <button class="loadAvatarButton" onsubmit="return false" type="button" onclick="toBack()">选择上传头像</button>
                    <input type="submit" class="submit" style="margin-top: 0;" value="立即注册">
                </div>
                <div id="back" style="display: none;">
                    <a href="javascript:void(0)" class="fileButton">
                        <input class="file" type="file" name="UserPhoto" accept="image/*" onchange="preview(this)">
                        <img src="userphoto/root.png" alt="" class="previewArea">
                    </a>
                    <br>
                    单击图片上传
                    <button class="loadAvatarButton" onsubmit="return false" type="button" onclick="toFront()">返回</button>
                </div>
            </form>
        </div>
        <iframe name="formTarget" id="formTarget" style="display: none;" onload="applyCheck(this)"></iframe>
        <script src="./js/background-image.js"></script>
        <script type="text/javascript" src="./js/ajax.js"></script>
        <script type="text/javascript" src="./js/sign.js"></script>
        <script type="text/javascript">
            function preview(element) {
                var previewArea = element.nextElementSibling;
                if (typeof FileReader == "undefined") {
                    previewArea.src = "";
                    previewArea.alt = "你的浏览器不支持预览";
                    return;
                }
                if (element.files[0]) {
                    if (element.files[0].size > 5248000) {
                        alert("图片太大，请重新选择");
                        element.value = "";
                        previewArea.src = "userphoto/root.png";
                        return;
                    }
                    var typeTest = /image\/\w+/;
                    if (typeTest.test(element.files[0].type)) {
                        var file = element.files[0];
                        var reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = function() {
                            previewArea.src = this.result;
                        }
                    } else {
                        previewArea.src = "";
                        previewArea.alt = "你打开的不是一个图片";
                    }
                }
            }
            function toBack() {
                document.getElementById("front").style.display = "none";
                document.getElementById("back").style.display = "inline-block";
            }
            function toFront() {
                document.getElementById("back").style.display = "none";
                document.getElementById("front").style.display = "inline-block";
            }
            function checkUserId(element) {
                var id = element.value;
                var checkReg = /^[1-9]\d{4,16}\d$/;
                if (checkReg.test(id)) {
                    ajax({
                        "url": "Check.php",
                        "data": {
                            "UserId": id
                        },
                        "success": function(response) {
                            var message = JSON.parse(response);
                            switch (message.result) {
                                case "Y":
                                    inputRight(element);
                                    break;
                                case "N":
                                    inputErr(element);
                                    break;
                            }
                        }
                    })
                } else if (id != "") {
                    inputErr(element);
                } else {
                    initInfo(element);
                }
            }
            function checkUserName(element) {
                var reg = /\s/;
                var name = element.value;
                if (reg.test(name)) {
                    check.innerHTML = "昵称中含有空白字符";
                    return;
                }
                var reg1 = /[^\u4e00-\u9fa5\s]/g;
                var reg2 = /[\u4e00-\u9fa5]/g;
                var arr1 = name.match(reg1)||[];
                var arr2 = name.match(reg2)||[];
                var length = arr1.length + (arr2.length * 2);
                if (length > 24) {
                    inputErr(element);
                    return;
                }
                if (name != "") {
                    ajax({
                        "url": "Check.php",
                        "data": {
                            "UserName": name
                        },
                        "success": function(response) {
                            message = JSON.parse(response);
                            switch (message.result) {
                                case "Y":
                                    inputRight(element);
                                    break;
                                case "N":
                                    inputErr(element);
                                    break;
                            }
                        }
                    });
                } else {
                    initInfo(element);
                }
            }
            function checkUserPassword(element) {
                var reg = /^\S{6,16}$/;
                var password = element.value;
                if (reg.test(password)) {
                    inputRight(element);
                } else if (password != "") {
                    inputErr(element);
                } else {
                    initInfo(element);
                }
            }
            function checkPasswordAgain(element) {
                var firstPassword = document.getElementById("UserPassword").value;
                var again = element.value;
                if (again == "") {
                    initInfo(element);
                    return;
                }
                if (again == firstPassword) {
                    inputRight(element);
                } else {
                    inputErr(element);
                }
            }
            function check() {
                if (document.getElementById("UserId").getAttribute("status") != "1") {
                    location.hash = "#UserId";
                    return false;
                }
                if (document.getElementById("UserName").getAttribute("status") != "1") {
                    location.hash = "#UserName";
                    return false;
                }
                if (document.getElementById("UserPassword").getAttribute("status") != "1") {
                    location.hash = "#UserPassword";
                    return false;
                } else {
                    return true;
                }
            }
            function applyCheck(iframe) {
                var response = iframe.contentDocument.getElementsByTagName("body")[0].innerHTML;
                var reg = /{.+}/;
                var message = JSON.parse(response.match(reg));
                if (message.result == "Y") {
                    alert("注册成功");
                    document.getElementById("apply").reset();
                    location.pathname = "/www/index.html";
                } else if(message.result == "N") {
                    resetCode();
                    if (message.msg == "\u9a8c\u8bc1\u7801\u9519\u8bef\uff01") {
                        inputErr(document.getElementById('Code'));
                    } else {
                        alert("可能是你姿势不对，注册失败了");
                    }
                }
            }
        </script>
    </body>
</html>